<!-- gallery-crud.component.html -->
<div class="container-fluid py-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="page-title">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <circle cx="8.5" cy="8.5" r="1.5"></circle>
          <path d="M21 15l-5-5L5 21"></path>
        </svg>
        Galería
      </h1>

      <p class="text-muted mb-0">Administra las imágenes de la galería pública</p>
    </div>
    <button class="btn btn-primary" (click)="openModal()">
      <i class="bi bi-plus-lg me-2"></i>
      Nueva Imagen
    </button>
  </div>

  <!-- Filtros -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <input type="text" class="form-control" placeholder="Buscar por título..." [(ngModel)]="searchTerm"
            (ngModelChange)="applyFilters()">
        </div>
        <div class="col-md-3">
          <select class="form-select" [(ngModel)]="filterFeatured" (ngModelChange)="applyFilters()">
            <option value="all">Todos</option>
            <option value="featured">Destacados</option>
            <option value="normal">No destacados</option>
          </select>
        </div>
        <div class="col-md-3">
          <select class="form-select" [(ngModel)]="filterVisible" (ngModelChange)="applyFilters()">
            <option value="all">Todos</option>
            <option value="visible">Visibles</option>
            <option value="hidden">Ocultos</option>
          </select>
        </div>
      </div>
    </div>
  </div>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-2">
      <span class="text-muted">
        Mostrando {{ (currentPage - 1) * pageSize + 1 }} -
        {{ Math.min(currentPage * pageSize, filteredGalleries.length) }}
        de {{ filteredGalleries.length }} imágenes
      </span>
    </div>

    <div class="d-flex align-items-center gap-2">
      <label class="text-muted mb-0">Por página:</label>
      <select class="form-select form-select-sm" style="width: auto;" [(ngModel)]="pageSize"
        (ngModelChange)="onPageSizeChange()">
        <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
      </select>
    </div>
  </div>
  <!-- Grid de imágenes -->
  <div class="row g-4" *ngIf="paginatedGalleries.length > 0">
    <div class="col-12 col-sm-6 col-md-4 col-lg-3" *ngFor="let gallery of paginatedGalleries">
      <div class="gallery-card" [class.featured]="gallery.featured" [class.hidden]="!gallery.isVisible">

        <!-- Imagen -->
        <div class="gallery-image-wrapper">
          <img [src]="gallery.imageUrl" [alt]="gallery.title || 'Imagen galería'" class="gallery-image"
            (error)="onImageError($event)">

          <!-- Badges -->
          <div class="gallery-badges">
            <span class="badge bg-warning" *ngIf="gallery.featured">
              <i class="bi bi-star-fill"></i> Destacado
            </span>
            <span class="badge bg-danger" *ngIf="!gallery.isVisible">
              <i class="bi bi-eye-slash"></i> Oculto
            </span>
          </div>

          <div class="gallery-overlay">
            <div class="gallery-actions">
              <button class="btn btn-sm btn-light" (click)="openModal(gallery)" title="Editar">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-warning" (click)="toggleFeatured(gallery)" [class.active]="gallery.featured"
                title="Destacar">
                <i class="bi" [class.bi-star]="!gallery.featured" [class.bi-star-fill]="gallery.featured"></i>
              </button>
              <button class="btn btn-sm" [class.btn-success]="!gallery.isVisible"
                [class.btn-secondary]="gallery.isVisible" (click)="deleteGallery(gallery)"
                title="{{ gallery.isVisible ? 'Ocultar' : 'Mostrar' }}">
                <i class="bi" [class.bi-eye-fill]="gallery.isVisible"
                  [class.bi-eye-slash-fill]="!gallery.isVisible"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Info -->
        <div class="gallery-info">
          <h6 class="gallery-title">{{ gallery.title || 'Sin título' }}</h6>
          <p class="gallery-description" *ngIf="gallery.description">
            {{ gallery.description }}
          </p>
          <small class="text-muted" *ngIf="gallery.createdAt">
            <i class="bi bi-calendar3"></i>
            {{ gallery.createdAt | date:'dd/MM/yyyy' }}
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty state -->
  <div class="text-center py-5" *ngIf="filteredGalleries.length === 0">
    <i class="bi bi-images text-muted" style="font-size: 4rem;"></i>
    <h4 class="mt-3">No hay imágenes</h4>
    <p class="text-muted">Comienza agregando imágenes a tu galería</p>
    <button class="btn btn-primary" (click)="openModal()">
      <i class="bi bi-plus-lg me-2"></i>
      Agregar Primera Imagen
    </button>
  </div>

</div>
<nav *ngIf="totalPages > 0" class="mt-4">
  <ul class="pagination justify-content-center">

    <li class="page-item" [class.disabled]="currentPage === 1">
      <a class="page-link" (click)="previousPage()" style="cursor: pointer;">
        <i class="bi bi-chevron-left"></i>
      </a>
    </li>

    <li class="page-item" *ngIf="showFirstPage">
      <a class="page-link" (click)="goToPage(1)" style="cursor: pointer;">1</a>
    </li>
    <li class="page-item disabled" *ngIf="showFirstPage && pageNumbers[0] > 2">
      <span class="page-link">...</span>
    </li>

    <li class="page-item" *ngFor="let page of pageNumbers" [class.active]="page === currentPage">
      <a class="page-link" (click)="goToPage(page)" style="cursor: pointer;">
        {{ page }}
      </a>
    </li>

    <li class="page-item disabled" *ngIf="showLastPage && pageNumbers[pageNumbers.length - 1] < totalPages - 1">
      <span class="page-link">...</span>
    </li>
    <li class="page-item" *ngIf="showLastPage">
      <a class="page-link" (click)="goToPage(totalPages)" style="cursor: pointer;">
        {{ totalPages }}
      </a>
    </li>

    <li class="page-item" [class.disabled]="currentPage === totalPages">
      <a class="page-link" (click)="nextPage()" style="cursor: pointer;">
        <i class="bi bi-chevron-right"></i>
      </a>
    </li>
  </ul>
</nav>
<!-- Modal de Formulario -->
<div class="modal fade" id="galleryModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          {{ isEditMode ? 'Editar Imagen' : 'Nueva Imagen' }}
        </h5>
        <button class="modal-close" data-bs-dismiss="modal">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
      
      </div>

      <form [formGroup]="galleryForm" (ngSubmit)="onSubmit()">
        <div class="modal-body">

          <div class="row g-3">

            <!-- Título -->
            <div class="col-12">
              <label class="form-label">Título</label>
              <input type="text" class="form-control" formControlName="title" placeholder="Ej: Interior del café">
            </div>

            <!-- Descripción -->
            <div class="col-12">
              <label class="form-label">Descripción</label>
              <textarea class="form-control" formControlName="description" rows="3"
                placeholder="Describe la imagen..."></textarea>
            </div>

            <!-- Preview de imagen actual -->
            <div class="col-12" *ngIf="isEditMode && selectedGallery?.imageUrl">
              <label class="form-label">Imagen actual</label>
              <div class="current-image-preview">
                <img [src]="selectedGallery?.imageUrl" alt="Imagen actual">
              </div>
            </div>

            <!-- Upload de imagen -->
            <div class="col-12">
              <label class="form-label">
                {{ isEditMode ? 'Cambiar imagen (opcional)' : 'Imagen *' }}
              </label>
              <input type="file" class="form-control" accept="image/*" (change)="onFileSelected($event)"
                [required]="!isEditMode">
              <small class="text-muted">
                Formatos: JPG, PNG, GIF. Máximo 5MB
              </small>
            </div>

            <!-- Preview de nueva imagen -->
            <div class="col-12" *ngIf="previewUrl">
              <label class="form-label">Vista previa</label>
              <div class="image-preview">
                <img [src]="previewUrl" alt="Vista previa">
                <button type="button" class="btn btn-sm btn-danger preview-remove" (click)="removeImage()">
                  <i class="bi bi-x-lg"></i>
                </button>
              </div>
            </div>

            <!-- Opciones -->
            <div class="col-12">
              <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" id="featured" formControlName="featured">
                <label class="form-check-label" for="featured">
                  <i class="bi bi-star-fill text-warning me-1"></i>
                  Imagen destacada
                </label>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="isVisible" formControlName="isVisible">
                <label class="form-check-label" for="isVisible">
                  <i class="bi bi-eye-fill me-1"></i>
                  Visible en galería pública
                </label>
              </div>
            </div>

          </div>

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary"
            [disabled]="loading || (galleryForm.invalid && !isEditMode && !selectedFile)">
            <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
            {{ loading ? 'Guardando...' : (isEditMode ? 'Actualizar' : 'Crear') }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>